[2025-10-26 13:58:11] [INFO] Starting remote deployment script. Log file: /c/Users/HP/IdeaProjects/hng-13-stage2-devops/deploy_20251026_135811.log
[2025-10-26 13:59:19] [INFO] Cloning repository: https://github.com/CYBERBOY001/hng-13-stage2-devops.git (branch: main)
[2025-10-26 13:59:19] [INFO] Repository exists, pulling latest changes...
[2025-10-26 13:59:21] [INFO] Repository cloned/updated successfully.
[2025-10-26 13:59:21] [INFO] Verifying project structure...
[2025-10-26 13:59:21] [INFO] Project files verified.
[2025-10-26 13:59:21] [INFO] Transferring project files to remote server...
[2025-10-26 13:59:46] [INFO] Preparing remote environment...
[2025-10-26 13:59:46] [INFO] Executing remotely: 
    sudo apt update && sudo apt upgrade -y

    if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo rm get-docker.sh
        echo 'Docker installed.'
    else
        echo 'Docker already installed.'
    fi

    if ! command -v docker-compose >/dev/null 2>&1; then
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)
        DOWNLOAD_URL="https://github.com/docker/compose/releases/latest/download/docker-compose-$OS-$ARCH"
        sudo curl -L "$DOWNLOAD_URL" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        if ! head -1 /usr/local/bin/docker-compose | grep -q '^#!'; then
            echo 'Invalid Docker Compose binary, redownloading...'
            sudo rm /usr/local/bin/docker-compose
            sudo curl -L "$DOWNLOAD_URL" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
        fi
        echo 'Docker Compose installed.'
    else
        echo 'Docker Compose already installed.'
    fi

    if ! groups $USER | grep -q docker; then
        sudo usermod -aG docker $USER
        echo 'User added to docker group.'
    fi

    sudo systemctl enable docker
    sudo systemctl start docker

    docker --version
    docker-compose --version

    if [[ -n "mkaey01" && -n "m?$7XMNQ_kP5at6" ]]; then
        echo 'm?$7XMNQ_kP5at6' | docker login https://index.docker.io/v1/ -u mkaey01 --password-stdin || { echo 'Docker login failed.'; exit 1; }
        echo 'Docker login successful.'
    else
        echo 'No Docker credentials provided, skipping login.'
    fi

[2025-10-26 13:59:55] [INFO] Deploying application on remote...
[2025-10-26 13:59:55] [INFO] Executing remotely: 
    cd /tmp/deploy_app

    docker-compose down || true
    docker system prune -f || true

    docker-compose up -d

    sleep 10
    if docker ps | grep -q app_blue || docker ps | grep -q app_green; then
        echo 'Containers are running.'
        docker-compose logs
    else
        echo 'Containers failed to start.'
        exit 1
    fi

