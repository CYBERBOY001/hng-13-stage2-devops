[2025-10-26 14:13:39] [INFO] Starting remote deployment script. Log file: /c/Users/HP/IdeaProjects/hng-13-stage2-devops/deploy_20251026_141339.log
[2025-10-26 14:15:38] [INFO] Cloning repository: https://github.com/CYBERBOY001/hng-13-stage2-devops.git (branch: main)
[2025-10-26 14:15:39] [INFO] Repository exists, pulling latest changes...
[2025-10-26 14:15:40] [INFO] Repository cloned/updated successfully.
[2025-10-26 14:15:40] [INFO] Verifying project structure...
[2025-10-26 14:15:40] [INFO] Project files verified.
[2025-10-26 14:15:41] [INFO] Transferring project files to remote server...
[2025-10-26 14:16:35] [INFO] Preparing remote environment...
[2025-10-26 14:16:35] [INFO] Executing remotely: 
    sudo apt update && sudo apt upgrade -y

    if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo rm get-docker.sh
        echo 'Docker installed.'
    else
        echo 'Docker already installed.'
    fi

    # Install Docker Compose v2 as plugin
    if [[ ! -f /usr/local/lib/docker/cli-plugins/docker-compose ]]; then
        sudo mkdir -p /usr/local/lib/docker/cli-plugins
        ARCH=$(uname -m)
        if [ "$ARCH" = "x86_64" ]; then
            COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64"
        else
            COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-aarch64"
        fi
        sudo curl -SL "$COMPOSE_URL" -o /usr/local/lib/docker/cli-plugins/docker-compose
        sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
        echo 'Docker Compose v2 installed.'
    else
        echo 'Docker Compose v2 already installed.'
    fi

    if ! groups $USER | grep -q docker; then
        sudo usermod -aG docker $USER
        echo 'User added to docker group.'
    fi

    sudo systemctl enable docker
    sudo systemctl start docker

    docker --version
    docker compose version

    if [[ -n "mkaey01" && -n "m?$7XMNQ_kP5at6" ]]; then
        echo 'm?$7XMNQ_kP5at6' | docker login https://index.docker.io/v1/ -u mkaey01 --password-stdin || { echo 'Docker login failed.'; exit 1; }
        echo 'Docker login successful.'
    else
        echo 'No Docker credentials provided, skipping login.'
    fi

[2025-10-26 14:16:48] [INFO] Deploying application on remote...
[2025-10-26 14:16:48] [INFO] Executing remotely: 
    cd /tmp/deploy_app

    docker compose down || true
    docker system prune -f || true

    docker compose up -d

    sleep 10
    if docker ps | grep -q app_blue || docker ps | grep -q app_green; then
        echo 'Containers are running.'
        docker compose logs
    else
        echo 'Containers failed to start.'
        exit 1
    fi

[2025-10-26 14:17:27] [INFO] Waiting for health checks...
[2025-10-26 14:17:27] [INFO] Executing remotely: 
    cd /tmp/deploy_app
    for i in {1..30}; do
        if docker compose ps | grep -q 'healthy'; then
            echo 'Health checks passed.'
            break
        fi
        sleep 2
    done

[2025-10-26 14:17:32] [INFO] Executing remotely: curl -f http://localhost:8080/healthz
[2025-10-26 14:17:36] [ERROR] Remote command failed with exit code 7
[2025-10-26 14:17:36] [ERROR] Health check failed on port 8080.
